"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),movingBus={};!function(){var a=Math.cos,b=Math.sin,c=Math.asin,d=Math.sqrt,e=Math.round,f=(Math.floor,Math.PI),g={},h={},i=function(a,b,c,d){var e=d.leftLng,g=d.topLat,h=d.rightLng,i=d.bottomLat;switch(a){case"WGS84":var j=b/(h-e),k=c/(i-g),l=-e*j,m=-g*k;return{getScaleShift:function(){return{scaleX:j,scaleY:k,shiftX:l,shiftY:m}},lng2X:function(a){return j*a+l},lat2Y:function(a){return k*a+m},x2Lng:function(a){return(a-l)/j},y2Lat:function(a){return(a-m)/k}};case"WebMercator":var n=b/(h-e),o=c/(Math.log(Math.tan(f/4+f*i/360))-Math.log(Math.tan(f/4+f*g/360))),p=-e*n,q=-Math.log(Math.tan(f/4+f*g/360))*o;return{getScaleShift:function(){return{scaleX:n,scaleY:o*f/180,shiftX:p,shiftY:q}},lng2X:function(a){return n*a+p},lat2Y:function(a){return o*Math.log(Math.tan(f/4+f*a/360))+q},x2Lng:function(a){return(a-p)/n},y2Lat:function(a){return 360*Math.atan(Math.exp((a-q)/o))/f-90}};default:throw"投影法指定有誤"}};movingBus.icons={add:function(a,b,c,d,e,f){var i=document.createElement("canvas"),j=i.getContext("2d"),k=document.createElement("canvas"),l=k.getContext("2d"),m=new Image;m.onload=function(){i.width=c,i.height=d,j.drawImage(m,0,0,c,d),k.width=c,k.height=d,l.drawImage(m,0,0,c,d),l.fillStyle="rgba(0,0,0,0.3)",l.globalCompositeOperation="destination-in",l.fillRect(0,0,c,d),l.globalCompositeOperation="source-over"},m.src=b,g[a]={cnv:i,targetX:e,targetY:f},h[a]=k},addFromCanvas:function(a,b,c,d){g[a]={cnv:b,targetX:c,targetY:d};var e=document.createElement("canvas"),f=e.getContext("2d");e.width=b.width,e.height=b.height,f.drawImage(b,0,0,width,height),f.fillStyle="rgba(0,0,0,0.3)",f.globalCompositeOperation="destination-in",f.fillRect(0,0,width,height),f.globalCompositeOperation="source-over",h[a]=e},list:function(){return g},remove:function(a){delete g[a],delete h[a]}},movingBus.Canvas=function(){function a(b,c,d){if(_classCallCheck(this,a),void 0===d.leftLng||void 0===d.topLat||void 0===d.rightLng||void 0===d.bottomLat)throw"參數boundary錯誤";this.cnv=b,this.ctx=b.getContext("2d"),this.width=b.width,this.height=b.height,this.proj=c,this.boundary=d,this.projFunc=i(c,b.width,b.height,d)}return _createClass(a,[{key:"setCanvas",value:function(a,b,c){this.cnv.width=a,this.cnv.height=b,this.width=cnv.width,this.height=cnv.height,this.boundary=c,this.projFunc=i(this.proj,a,b,c)}}]),a}(),movingBus.Shape=function(){function g(h){if(_classCallCheck(this,g),!h||h.length%2==1)throw"參數錯誤";this.lngLats=h,this.numPoints=h.length/2,this.accuDists=new Uint32Array(this.numPoints),this.totalDist=0;var i=void 0,j=void 0,k=void 0,l=void 0,m=void 0,n=void 0,o=void 0;for(this.accuDists[0]=0,i=1;i<this.numPoints;i++)j=this.lngLats[2*i-1]*f/180,k=this.lngLats[2*i+1]*f/180,l=(this.lngLats[2*i]-this.lngLats[2*i-2])*f/180,m=b((k-j)/2),m*=m,n=b(l/2),n*=a(j)*a(k)*n,o=e(2*c(d(m+n))*6378137),this.accuDists[i]=this.accuDists[i-1]+o;this.totalDist=this.accuDists[this.numPoints-1]}return _createClass(g,[{key:"findSectionIdx",value:function(a){var b=void 0;if(!(a<0||a>this.totalDist)){if(a===this.totalDist)return this.numPoints-1;if(this.numPoints<4096){for(b=0;b<this.numPoints&&!(a<this.accuDists[b]);b++);b--}else{var c=0,d=this.numPoints-1;for(b=d+c>>>1;d-c>1&&this.accuDists[b]!==a;)this.accuDists[b]>a?d=b:c=b,b=d+c>>>1}return b}}},{key:"getLngLat",value:function(a){var b=this.findSectionIdx(a);if(void 0!==b){if(a===this.accuDists[b])return[this.lngLats[2*b],this.lngLats[2*b+1]];var c=(a-this.accuDists[b])/(this.accuDists[b+1]-this.accuDists[b]),d=1-c;return[this.lngLats[2*b]*d+this.lngLats[2*b+2]*c,this.lngLats[2*b+1]*d+this.lngLats[2*b+3]*c]}}},{key:"createIterator",value:function(a){var b=this;if(!(a<0||a>this.totalDist)){var c=new Float32Array(2),d=this.findSectionIdx(a),e=function(a){if(b.accuDists[d+1]<=a){for(d+=2;d<b.numPoints&&!(b.accuDists[d]>a);d++);d--}var e=(a-b.accuDists[d])/(b.accuDists[d+1]-b.accuDists[d]),f=1-e;return c[0]=b.lngLats[2*d]*f+b.lngLats[2*d+2]*e,c[1]=b.lngLats[2*d+1]*f+b.lngLats[2*d+3]*e,c};return e.initial=function(a){d=b.findSectionIdx(a)},e}}}],[{key:"createFromWKT",value:function(a){var b=/linestring\(([^()]*)\)/gi.exec(a)[1];if(b){var c=b.split(","),d=new Float32Array(2*c.length),e=void 0,f=void 0;for(e=0;e<c.length;e++)f=c[e].split(" "),d[2*e]=parseFloat(f[0]),d[2*e+1]=parseFloat(f[1]);return new this(d)}}}]),g}(),movingBus.Bus=function(){var a=function a(b,c,d,e,f,i){if(_classCallCheck(this,a),!(b instanceof movingBus.Shape))throw"參數shape必須為Shape物件";if(e.length!==f.length)throw"參數dists與times陣列長度不一致";if(0!==e[0]||0!==f[0])throw"參數dists與times的第0個元素必須為0";if(null===e[e.length-1]||null===f[f.length-1])throw"參數dists與times的最後一個元素皆不可為null";if(!(i instanceof movingBus.Canvas))throw"參數movingBusCnv必須為movingBus.Canvas物件";this.totalDist=e[e.length-1],this.totalTime=f[f.length-1],this.plate=c,c=null,this.plateDisplay=a.default.plateDisplay,this.platePosition=a.default.platePosition;var j=document.createElement("canvas"),k=j.getContext("2d");this.setPlateStyle=function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,c=b|k.measureText(this.plate).width,d=a/10;j.width=Math.ceil((c+1)*d),j.height=Math.ceil(3*a/2*d),k.scale(d,d),k.fillText(this.plate,.5,10)},this.setPlateStyle(a.default.plateFontSize);var l=void 0,m=void 0,n=void 0,o=void 0;if(void 0!==d.key){var p=g[d.key];if(l=p.cnv,m=p.targetX,n=p.targetY,o=h[d.key],void 0===l)throw"參數icon指定之key值，並不為任何快取於javascript內icon的key值"}else{if(void 0===d.url||void 0===d.width||void 0===d.height)throw"參數icon錯誤";l=document.createElement("canvas");var q=l.getContext("2d");o=document.createElement("canvas");var r=o.getContext("2d"),s=new Image;s.onload=function(){l.width=d.width,l.height=d.height,q.drawImage(s,0,0,d.width,d.height),o.width=d.width,o.height=d.height,r.drawImage(s,0,0,d.width,d.height),r.fillStyle="rgba(0,0,0,0.3)",r.globalCompositeOperation="destination-in",r.fillRect(0,0,d.width,d.height),r.globalCompositeOperation="source-over"},s.src=d.url}var t=void 0,u=void 0,v=e.length,w=0,x=void 0,y=void 0,z=void 0,A=void 0;for(t=1;t<v;t++)null!==e[t]&&null!==f[t]&&w++;for(x=new Uint8Array(w),y=new Float32Array(w),z=new Uint32Array(w+1),A=new Uint32Array(w+1),z[0]=0,A[0]=0,w=0,t=1,u=0;t<v;t++)null!==e[t]&&null!==f[t]&&(x[w]=t-u==1?1:0,z[w+1]=e[t],A[w+1]=f[t],y[w]=(e[t]-e[u])/(f[t]-f[u]),w++,u=t);var B=0,C=void 0,D=void 0,E=void 0,F=void 0,G=0,H=i.cnv.getContext("2d"),I=(i.width,i.height,i.projFunc),J=b.createIterator(0),K=J(0);C=K[0],D=K[1],E=I.lng2X(C),F=I.lat2Y(D),this.getTime=function(){return B},this.getPosition=function(){return[C,D]},this.findSectionIdx=function(a){var b=void 0;if(!(a<0||a>A[w])){if(a===A[w])return w;if(w<=4096){for(b=0;b<=w&&!(a<A[b]);b++);b--}else{var c=0,d=w;for(b=d+c>>>1;d-c>1&&A[b]!==a;)A[b]>a?d=b:c=b,b=d+c>>>1}return b}},this.getDist=function(a,b){return void 0===b&&(b=this.findSectionIdx(a)),z[b]+(a-A[b])*y[b]},this.setTime=function(a){a<0||a>A[w]||(I=i.projFunc,B=a,G=this.findSectionIdx(a),J.initial(this.getDist(a,G)),K=J(0),C=K[0],D=K[1],E=I.lng2X(C),F=I.lat2Y(D))},this.drive=function(a){if(A[G+1]<=a){for(G+=2;G<=w&&!(A[G]>a);G++);G--}var b=i.projFunc;B=a,K=J(z[G]+(a-A[G])*y[G]),C=K[0],D=K[1],E=b.lng2X(C),F=b.lat2Y(D),x[G]?H.drawImage(l,E-m,F-n):H.drawImage(o,E-m,F-n),this.plateDisplay&&("b"===this.platePosition?H.drawImage(j,E+l.width/2-j.width/2-m,F+l.height-n):H.drawImage(j,E+l.width/2-j.width/2-m,F-j.height-n))}};return a.default={plateDisplay:!0,platePosition:"b",plateFontSize:10},a}()}();